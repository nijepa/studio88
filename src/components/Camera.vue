<template>
  <div class="user__form">
    <div class="camera">
<!--       <button
        type="submit"
        @click.prevent="closeCamera"
        class="action_btn client__add for_mobile"
      >
        <svg
          version="1.1"
          id="Layer_1"
          x="0px"
          y="0px"
          height="40px"
          viewBox="0 0 408.761 408.761"
          style="enable-background: new 0 0 408.761 408.761"
          xml:space="preserve"
        >
          <g>
            <path
              style="fill: var(--purple-light)"
              d="M204.385,408.761c-58.121,0-113.675-24.868-152.418-68.227
                    C18.46,303.059,0.005,254.703,0.005,204.381C0.005,91.685,91.689,0,204.385,0c50.317,0,98.674,18.455,136.163,51.964
                    c43.348,38.762,68.207,94.316,68.207,152.417C408.755,317.076,317.075,408.761,204.385,408.761"
            />
            <path
              style="fill: var(--purple)"
              d="M377.759,204.379c0,18.08-2.77,35.521-7.911,51.901c-0.849,2.72-1.769,5.409-2.759,8.07
                    c-16.511,44.83-51.031,80.96-94.791,99.59c-15.779,6.729-32.759,11.18-50.529,12.95c-5.721,0.58-11.51,0.87-17.38,0.87
                    c-51.39,0-97.561-22.361-129.301-57.881c-0.26-0.29-0.519-0.589-0.79-0.879c-26.95-30.562-43.289-70.681-43.289-114.622
                    c0-95.749,77.619-173.38,173.38-173.38c43.95,0,84.069,16.35,114.629,43.291c0.29,0.27,0.591,0.53,0.881,0.79
                    C355.409,106.84,377.759,152.989,377.759,204.379"
            />
            <path
              style="fill: var(--purple)"
              d="M74.354,319.061c3.691,4.18,7.58,8.181,11.653,11.988c-3.805-3.558-7.447-7.283-10.918-11.168
                    C74.846,319.61,74.605,319.332,74.354,319.061 M64.213,306.438c0.014,0.019,0.031,0.042,0.045,0.062
                    C64.243,306.479,64.228,306.458,64.213,306.438 M63.885,305.987c0.062,0.085,0.125,0.173,0.187,0.258
                    C64.009,306.158,63.948,306.074,63.885,305.987 M63.606,305.601c0.063,0.088,0.128,0.177,0.191,0.265
                    C63.733,305.777,63.671,305.69,63.606,305.601 M63.304,305.18c0.086,0.12,0.172,0.241,0.259,0.361
                    C63.476,305.421,63.389,305.299,63.304,305.18 M163.353,35.884C87.403,54.315,31.004,122.757,31.004,204.371
                    c0,37.592,11.957,72.385,32.283,100.785c-20.323-28.403-32.278-63.193-32.278-100.777C31.009,122.766,87.402,54.317,163.353,35.884
                    "
            />
            <path
              style="fill: var(--purple)"
              d="M204.383,31.001c-14.138,0-27.875,1.691-41.03,4.883C87.402,54.317,31.009,122.766,31.009,204.379
                    c0,37.584,11.955,72.375,32.278,100.778c0.005,0.007,0.011,0.016,0.016,0.023c0.086,0.12,0.173,0.241,0.259,0.361
                    c0.014,0.02,0.03,0.042,0.044,0.061c0.064,0.089,0.127,0.176,0.191,0.265c0.03,0.042,0.057,0.08,0.088,0.121
                    c0.063,0.087,0.124,0.171,0.187,0.258c0.048,0.066,0.093,0.127,0.141,0.193c0.015,0.02,0.03,0.041,0.045,0.062
                    c3.172,4.344,6.542,8.536,10.096,12.561c0.251,0.271,0.492,0.549,0.735,0.819c3.472,3.885,7.114,7.61,10.918,11.168
                    c2.105,1.967,4.258,3.882,6.458,5.743c-25.531-30.2-40.921-69.241-40.921-111.88c0-95.751,77.621-173.37,173.381-173.37
                    c42.629,0,81.68,15.39,111.869,40.919C305.004,54.871,257.485,31.001,204.383,31.001"
            />
            <path
              style="fill: var(--purple)"
              d="M296.129,193.38l-146.18,12.269v35.941l122.35,122.35c43.76-18.63,78.28-54.76,94.791-99.59
                    L296.129,193.38"
            />
            <polygon
              style="fill: #ffffff"
              points="112.634,204.381 149.945,167.169 149.945,193.381 296.125,193.381 296.125,215.381 
                    149.945,215.381 149.945,241.593 	"
            />
          </g>
        </svg>
        <p>Nazad</p>
      </button> -->
      <video id="video" autoplay class="video"></video>
      <loading pic="loading1" v-if="loadingState" key="1" />

      <form
        method="post"
        @submit.prevent="savePicture(pic)"
        v-else
        class=""
        key="2"
      >
        <button
          id="snap"
          class="action_btn client__add for_mobile for__camera"
          @click.prevent="takePicture"
        >
          <svg
            x="0px"
            y="0px"
            width="40px"
            height="40px"
            viewBox="0 0 477.418 477.419"
            style="enable-background: new 0 0 477.418 477.419"
            xml:space="preserve"
            fill="var(--purple)"
          >
            <circle cx="249.209" cy="160.576" r="6.448" />
            <circle cx="220.959" cy="160.576" r="11.75" />
            <path
              d="M363.417,113.712H213.609c-21.324,0-38.611,17.287-38.611,38.61v286.485c0,21.325,17.287,38.612,38.611,38.612h149.808
                c21.324,0,38.609-17.287,38.609-38.612V152.322C402.026,130.999,384.741,113.712,363.417,113.712z M245.959,182.826h-26.5
                c-12.288,0-22.25-9.962-22.25-22.25c0-12.288,9.962-22.25,22.25-22.25h26.5c12.287,0,22.25,9.962,22.25,22.25
                C268.209,172.864,258.247,182.826,245.959,182.826z"
            />
            <polygon
              points="116.076,110.817 177.572,102.86 183.627,43.549 221.85,95.55 260.706,74.693 253.958,95.618 271.01,95.618 
                288.512,41.349 226.584,74.589 171.758,0 162.734,88.415 75.393,99.718 136.939,147.624 88.264,212.627 157.947,201.267 
                157.947,184.823 125.383,190.132 159.479,144.601 		"
            />
          </svg>
          Slikaj
        </button>
        <canvas id="canvas" width="350" height="200" class="snap"></canvas>
        <!--         <button
          type="submit"
          class="action_btn save__btn for__camera"
          @click.prevent="savePicture(pic)"
        >
          <svg
            version="1.1"
            id="Layer_1"
            x="0px"
            y="0px"
            height="40px"
            viewBox="0 0 408.759 408.759"
            style="enable-background: new 0 0 408.759 408.759"
            xml:space="preserve"
          >
            <g>
              <path
                style="fill: #8bdd6b"
                d="M204.383,408.759c-58.121,0-113.674-24.867-152.417-68.225
                C18.46,303.057,0.005,254.703,0.005,204.381C0.005,91.685,91.688,0,204.383,0c50.319,0,98.674,18.455,136.164,51.964
                c43.346,38.762,68.207,94.316,68.207,152.417C408.755,317.076,317.074,408.759,204.383,408.759"
              />
              <path
                style="fill: #35af05"
                d="M377.755,204.379c0,18.08-2.77,35.52-7.909,51.901c-15.6,49.779-53.02,89.899-101.069,109.11
                c-4.69,1.889-9.481,3.56-14.361,5.03c-10.5,3.16-21.419,5.35-32.65,6.47c-5.719,0.58-11.51,0.87-17.38,0.87
                c-51.39,0-97.559-22.361-129.299-57.881c-0.26-0.29-0.521-0.591-0.79-0.881c-26.95-30.56-43.29-70.68-43.29-114.62
                c0-95.749,77.621-173.38,173.379-173.38c43.951,0,84.071,16.35,114.631,43.29c0.29,0.27,0.589,0.53,0.879,0.79
                c33.66,30.1,55.491,73.13,57.67,121.299v0.011C377.696,199.04,377.755,201.699,377.755,204.379"
              />
              <path
                style="fill: #1c6300"
                d="M74.34,319.046c3.509,3.976,7.2,7.791,11.056,11.43c-3.585-3.385-7.023-6.919-10.309-10.596
                C74.84,319.605,74.594,319.321,74.34,319.046 M59.6,299.796c0.005,0.008,0.011,0.016,0.016,0.024
                C59.611,299.813,59.604,299.802,59.6,299.796 M59.097,299.029c0.017,0.025,0.031,0.048,0.048,0.073
                C59.128,299.078,59.113,299.054,59.097,299.029 M58.793,298.562c0.021,0.033,0.041,0.063,0.062,0.096
                C58.834,298.626,58.813,298.593,58.793,298.562 M58.495,298.102c0.056,0.086,0.108,0.168,0.164,0.254
                C58.605,298.272,58.549,298.186,58.495,298.102 M58.272,297.754c0.036,0.056,0.075,0.117,0.111,0.173
                C58.346,297.869,58.31,297.813,58.272,297.754 M57.99,297.312c0.044,0.069,0.089,0.14,0.133,0.208
                C58.078,297.451,58.034,297.381,57.99,297.312 M57.71,296.87c0.061,0.097,0.124,0.197,0.186,0.293
                C57.834,297.067,57.771,296.967,57.71,296.87 M57.474,296.496c0.051,0.082,0.102,0.162,0.153,0.244
                C57.576,296.659,57.524,296.576,57.474,296.496 M57.209,296.074c0.061,0.097,0.123,0.197,0.184,0.295
                C57.333,296.271,57.27,296.171,57.209,296.074 M56.936,295.635c0.067,0.108,0.133,0.214,0.2,0.322
                C57.069,295.849,57.003,295.743,56.936,295.635 M56.696,295.246c0.062,0.1,0.12,0.195,0.182,0.295
                C56.817,295.443,56.756,295.344,56.696,295.246 M56.439,294.829c0.071,0.116,0.142,0.231,0.213,0.347
                C56.582,295.061,56.51,294.944,56.439,294.829 M56.173,294.392c0.072,0.119,0.144,0.237,0.217,0.355
                C56.318,294.63,56.244,294.51,56.173,294.392 M55.922,293.98c0.073,0.121,0.146,0.242,0.22,0.363
                C56.069,294.221,55.996,294.102,55.922,293.98 M55.681,293.58c0.076,0.127,0.153,0.254,0.229,0.38
                C55.834,293.834,55.757,293.706,55.681,293.58 M55.419,293.143c0.077,0.13,0.154,0.258,0.232,0.387
                C55.574,293.402,55.496,293.272,55.419,293.143 M54.935,292.328c0.161,0.273,0.321,0.542,0.484,0.815
                C55.257,292.872,55.096,292.599,54.935,292.328 M152.31,38.956C81.994,61.064,31.004,126.76,31.004,204.37
                c0,32.099,8.717,62.156,23.919,87.936c-15.2-25.78-23.917-55.835-23.917-87.927C31.006,126.769,81.994,61.067,152.31,38.956"
              />
              <path
                style="fill: #35af05"
                d="M204.383,31.001c-18.142,0-35.638,2.787-52.073,7.955C81.994,61.067,31.006,126.769,31.006,204.379
                c0,32.092,8.717,62.147,23.917,87.927c0.003,0.005,0.01,0.016,0.013,0.022c0.16,0.271,0.322,0.544,0.484,0.815v0.001
                c0.077,0.129,0.155,0.259,0.232,0.387c0.009,0.016,0.02,0.034,0.03,0.05c0.076,0.126,0.153,0.254,0.229,0.38
                c0.005,0.008,0.007,0.012,0.012,0.02c0.074,0.122,0.146,0.241,0.22,0.363c0.009,0.016,0.021,0.034,0.03,0.049
                c0.071,0.117,0.145,0.238,0.217,0.355c0.016,0.026,0.034,0.056,0.05,0.082c0.071,0.115,0.142,0.232,0.213,0.347
                c0.014,0.023,0.029,0.047,0.043,0.07c0.06,0.098,0.122,0.197,0.182,0.295c0.019,0.031,0.039,0.063,0.058,0.094
                c0.067,0.108,0.133,0.214,0.2,0.322c0.024,0.038,0.049,0.079,0.073,0.117c0.061,0.097,0.123,0.197,0.184,0.295
                c0.027,0.043,0.053,0.084,0.08,0.127c0.051,0.08,0.103,0.163,0.153,0.244c0.027,0.043,0.055,0.088,0.083,0.131
                c0.061,0.097,0.124,0.197,0.186,0.293c0.032,0.051,0.062,0.097,0.094,0.148c0.044,0.069,0.088,0.139,0.133,0.208
                c0.05,0.079,0.099,0.156,0.15,0.234c0.038,0.059,0.073,0.114,0.111,0.173c0.037,0.058,0.074,0.116,0.112,0.174
                c0.054,0.084,0.109,0.17,0.164,0.254c0.044,0.068,0.089,0.138,0.134,0.206c0.02,0.031,0.042,0.065,0.062,0.096
                c0.079,0.121,0.163,0.25,0.242,0.371c0.016,0.025,0.032,0.048,0.048,0.073c0.152,0.232,0.302,0.462,0.455,0.693
                c0.004,0.006,0.012,0.018,0.016,0.024c4.462,6.754,9.386,13.178,14.724,19.226c0.254,0.275,0.5,0.559,0.747,0.834
                c3.286,3.677,6.724,7.212,10.309,10.596c2.298,2.169,4.654,4.273,7.068,6.315c-25.53-30.2-40.919-69.241-40.919-111.881
                c0-95.749,77.619-173.368,173.379-173.368c42.631,0,81.68,15.39,111.87,40.919C305.004,54.871,257.483,31.001,204.383,31.001"
              />
              <path
                style="fill: #35af05"
                d="M317.613,136.427L178.714,275.326l90.064,90.064c48.049-19.21,85.469-59.33,101.069-109.11
                c5.139-16.381,7.909-33.821,7.909-51.901c0-2.679-0.059-5.339-0.19-7.989v-0.011l0,0l-50.069-50.069"
              />
              <polyline
                style="fill: #ffffff"
                points="188.597,285.205 102.651,199.26 118.207,183.704 188.597,254.094 311.936,130.754 
                327.492,146.31 188.597,285.205 	"
              />
            </g>
          </svg>
          <p>Sačuvaj</p>
        </button> -->
      </form>
    </div>
    <div class="modify_btns">
      <action-buttons @canceled="handleCancel" />
    </div>
  </div>
</template>

<script>
import axios from "axios";
import { mapGetters, mapActions } from "vuex";
import ActionButtons from "@/components/utils/ActionButtons.vue";
import Loading from "@/components/utils/Loading.vue";
import actionsNotify from "@/mixins/actionsNotify";

export default {
  name: "Camera",

  components: {
    Loading,
    ActionButtons,
  },

  mixins: [actionsNotify],

  data() {
    return {
      url: process.env.VUE_APP_CLOUDINARY,
      pic: null,
      clientInput: {
        picture: "",
      },
      picData: {},
    };
  },

  computed: {
    ...mapGetters(["getOneClient", "getErrors", "loadingState"]),
  },

  methods: {
    ...mapActions(["clientUpdate", "clearErrors", "setLoadingState"]),

    handleCancel() {
      this.closeCamera();
    },

    async updateClientPhoto() {
      //this.setLoadingState(true);
      await this.clientUpdate(this.clientInput);
      //await this.fetchClients();
      if (this.getErrors.length) {
        this.$toast.error(
          "Greška! " + this.getErrors,
          "OK",
          this.notificationSystem.options.error
        );
        this.clearErrors();
      } else {
        this.$toast.success(
          "Uspješno sačuvano!",
          "OK",
          this.notificationSystem.options.success
        );
      }
    },

    takePicture() {
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      const video = document.getElementById("video");

      /*       const ratio = this.calculateProportionalAspectRatio(
        video.scrollWidth,
        video.scrollHeight,
        canvas.width,
        canvas.height
      ); */
      //context.drawImage(video,0,0,video.scrollWidth*ratio,video.scrollHeight*ratio);

      context.drawImage(video, 0, 0, 350, 200);
      this.pic = canvas;
    },

    // Calculate the ratio that fills the canvas
    // but doesn't stretch the image pixels
    // (This may cause some pixels to be clipped)
    calculateProportionalAspectRatio(srcWidth, srcHeight, maxWidth, maxHeight) {
      return Math.min(maxWidth / srcWidth, maxHeight / srcHeight);
    },

    async savePicture(canvas) {
      // Converts canvas to an image
      let image = new Image();
      image.src = canvas.toDataURL("image/png");
      //return image;
      const unsignedUploadPreset = process.env.VUE_APP_UNSIGNED_UPLOAD_PRESET;
      const formData = new FormData();
      formData.append("file", image.src);
      formData.append("upload_preset", unsignedUploadPreset);
      await this.saveClientPhoto(formData);
      await this.updateClientPhoto();
      await this.setLoadingState(false);
      this.closeCamera();
    },

    async saveClientPhoto(clientData) {
      this.setLoadingState(true);
      await axios
        .post(this.url, clientData)
        .then((response) => {
          this.clientInput.picture = response.data.secure_url;
        })
        .catch((error) => {
          if (error.response) {
            console.log = error.response.data.error;
          } else {
            console.log = error;
          }
        });
    },

    closeCamera() {
      this.$emit("cam-closed");
    },
  },

  mounted() {
    const video = document.getElementById("video");
    // Get access to the camera!
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      // Not adding `{ audio: true }` since we only want video now
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then(function (stream) {
          //video.src = window.URL.createObjectURL(stream);
          video.srcObject = stream;
          video.play();
        });
    }
    this.clientInput = this.getOneClient;
  },
};
</script>

<style>
.camera {
  display: grid;
  margin: 0.5em;
}

.video {
  width: 350px;
  height: 200px;
}

.for__camera {
  justify-self: center;
}
</style>
